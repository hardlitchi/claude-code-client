# Claude Code Client 要件定義 疑問点

README.mdを読んで整理した疑問点と明確化が必要な項目です。

## 1. Claude Code との統合方法について

### 疑問点
- **Claude Code CLI との統合方法**: どのようにClaude Code CLIと連携するのか？
  - Claude Code CLIを子プロセスとして起動？
  - APIやプロトコル経由での通信？
  - Claude Code のセッション状態をどう管理？

- **複数セッション管理**: 「複数のClaudeセッションを管理」とあるが
  - 1つのClaude Code CLIで複数プロジェクト？
  - 複数のClaude Code CLIプロセス？
  - セッション間でのリソース分離方法は？

### 回答
- Clude Code CLI との統合方法
  - Claude Code SDK を使用して通信します。
  - セッションやプロセスの管理は、Claude Code SDK が提供する手法で実施してください。
  - セッションは、DBで管理しましょう。
- 複数セッション管理
  - Claude Code CLI との統合方法の回答を参照してください。

## 2. 認証・セキュリティについて

### 疑問点
- **認証方式**: どのような認証方式を使用？
  - 独自のユーザー管理？
  - OAuth（Google/GitHub等）？
  - 基本認証？

- **セキュリティ要件**: 
  - 複数ユーザーでの同時使用を想定？
  - ファイルシステムへのアクセス制御は？
  - Claude Code の API キー管理方法は？

### 回答
- 認証方式
  - ID/Password 方式を考えています。
  - 将来的にはOAuth認証に対応したいです。
- セキュリティ要件
  - 複数ユーザでの同時使用を想定しています。
  - ログインユーザに対応するユーザを環境上に用意し、このユーザの権限で操作をします。
  - APIキーは、Claude Code SDK の提案するものを採用します。

## 3. Terminal機能について

### 疑問点
- **Terminal の実装方式**:
  - Web上でのTerminalエミュレーター？
  - サーバー上のシェルへの直接アクセス？
  - セキュリティ制限の範囲は？

- **権限管理**: 
  - どのコマンドを実行可能？
  - ファイルシステムアクセスの制限は？
  - sudo等の管理者権限は必要？

### 回答
- Terminal の実装方式
  - エミュレートではなく、VSCodeなどのように、サーバ上のシェルに直接アクセスできるようにしてほしいです。
  - セキュリティ権限、権限管理は、ログインユーザに対応する、サーバ上のユーザの権限に応じます。
  - sudores であれば sudo も実行可能にしてください。

## 4. 通知・連携機能について

### 疑問点
- **プッシュ通知の実装**:
  - Web Push API を使用？
  - モバイルアプリも対象？
  - 通知のタイミングと内容は？

- **Webhook連携の詳細**:
  - どのイベントでWebhookを発火？
  - 各サービス（LINE/Slack/Discord）での認証方法は？
  - メッセージフォーマットは？

### 回答
- プッシュ通知の実装
  - Web Push API の使用を想定しています。
  - モバイルアプリも対象にしたいです。
  - Claudeがユーザに確認を求めるタイミングや、作業を完了したタイミングで通知してください。

- Webhook連携の詳細
  - プッシュ通知のタイミングと内容に習います。
  - 認証はAPIキーやシークレットで実施します。
  - フォーマットは各サービスのベストプラクティスを採用したいです。

## 5. デプロイ機能について

### 疑問点
- **デプロイ対象**: 「作成中のアプリのデプロイ」とは
  - どのような種類のアプリケーション？
  - デプロイ先は（AWS/GCP/Heroku等）？
  - デプロイ設定の管理方法は？

- **デプロイ権限**: 
  - デプロイに必要な認証情報の管理は？
  - 本番環境への直接デプロイ？

### 回答
デプロイ機能については現時点で考慮不要です。  
将来的な機能拡張として記録しておいてください。

## 6. 技術的な詳細

### 疑問点
- **使用技術スタック**:
  - WebフレームワークはFlask/FastAPI/Django？
  - フロントエンドはどう実装？（React/Vue/vanilla JS？）
  - データベースは必要？（セッション管理用）

- **WebSocket通信**:
  - リアルタイム通信が必要な機能は？
  - Terminal操作での双方向通信？
  - チャット機能でのリアルタイム更新？

### 回答
- 使用技術スタック
  - お勧めの構成があればご提案お願いいたします。
  - データベースは必要です。
- WebSocket通信
  - Terminal操作や、Claudeとのチャット、通知などでリアルタイム通信が必要な認識です。

## 7. 運用・保守について

### 疑問点
- **セッション永続化**:
  - セッション情報の保存場所は？
  - サーバー再起動時の復旧方法は？
  - セッションの有効期限は？

- **ログ・監視**:
  - どのような操作ログを記録？
  - エラーハンドリングの方針は？
  - パフォーマンス監視は必要？

### 回答
- セッション永続化
  - セッション情報はDBにh損してください。
  - サーバ再起動時には、DBから各種設定や作業状況を取得してください。
  - 有効期限は現時点では無期限を想定してください。

- ログ・監視
  - ユーザへの確認が発生する作業や、作業内容の要約をログに記録しましょう。
  - 不正操作や実行失敗などはユーザに通知し、ログに出力してください。
  - パフォーマンス監視は必要です。

## 回答をお願いしたい優先順位

1. **最優先**: Claude Code CLI との統合方法
2. **高優先**: 認証方式とセキュリティ要件
3. **中優先**: 使用技術スタックとアーキテクチャ
4. **低優先**: 詳細な運用要件

---

## 追加確認事項と提案

### 重要な確認事項

#### 1. Claude Code SDK について
**疑問**: 「Claude Code SDK を使用」とありますが、現在 Claude Code には公式SDKが存在しないようです。
- Claude Code CLI は単体のツールとして動作
- プログラマティックなAPIは提供されていない模様

**確認が必要**: 
- Claude Code CLI をサブプロセスとして起動し、stdin/stdout経由で通信することを想定？
- 別の統合方法をお考えでしょうか？

**回答**:
- こちらにあるようです。参考：https://docs.anthropic.com/ja/docs/claude-code/sdk
- もしも使用難易度が高ければstdin/stdout経由で通信してもよいです。

#### 2. 複数ユーザー対応でのシステム設計
**懸念点**: 
- 「ログインユーザに対応するユーザを環境上に用意」とありますが、これは各Webユーザーに対してサーバー上のLinuxユーザーを作成することを意味？
- セキュリティリスクが高い可能性があります

**代替案提案**: 
- コンテナ化（Docker）による分離
- chroot環境での実行
- 専用の実行ユーザーでの権限制御

**回答**:
- Docker による分離、よいですね。
- 専用の実行ユーザーでの権限制御 も問題ありません。

### 技術スタック提案

#### バックエンド構成
```
・Webフレームワーク: FastAPI
  - WebSocket対応が優秀
  - 自動API文書生成
  - 高性能でPythonの型ヒント対応

・データベース: PostgreSQL + SQLAlchemy
  - 堅牢性とパフォーマンス
  - JSON型対応でセッション情報格納に適している

・WebSocket: FastAPI内蔵 + Socket.IO
  - リアルタイム通信の安定性

・認証: FastAPI Security + JWT
  - 将来のOAuth対応も容易
```

#### フロントエンド構成
```
・フレームワーク: Vue.js 3 + TypeScript
  - 学習コストが低い
  - リアクティブなUI更新
  - Terminal.jsとの相性が良い

・ターミナル: xterm.js
  - Web上でのターミナルエミュレートの標準
  - VSCode等でも使用されている

・状態管理: Pinia（Vue公式推奨）
・CSS: Tailwind CSS（迅速な開発）
```

#### インフラ構成
```
・コンテナ化: Docker + Docker Compose
・リバースプロキシ: Nginx
・プロセス管理: systemd または Docker
・ログ収集: 標準ログ + structured logging
```

### 新たな疑問点

#### セキュリティ設計について
1. **プロセス分離**: 各ユーザーのClaude Code実行を隔離する方法
2. **ファイルアクセス制御**: 他のユーザーのファイルにアクセスできない保証
3. **リソース制限**: CPU/メモリ使用量の制限方法

#### 運用設計について
1. **バックアップ戦略**: ユーザーデータとセッション情報の保護
2. **スケーリング**: 複数ユーザー同時接続時の性能対策
3. **エラー復旧**: Claude Code プロセス異常終了時の対応

### 実装優先順位の提案

**フェーズ1（MVP）**:
1. 基本的なWeb UI構築
2. 単一ユーザー向けTerminal機能
3. Claude Code CLIとの基本統合
4. シンプルな認証機能

**フェーズ2（マルチユーザー対応）**:
1. ユーザー管理機能
2. セッション分離機能
3. 基本的な通知機能

**フェーズ3（高度な機能）**:
1. Webhook連携
2. OAuth認証
3. モバイル対応

---

**確認をお願いしたい点**:
1. Claude Code SDK についての理解は正しいでしょうか？
2. セキュリティ要件について代替案は受け入れ可能でしょうか？
3. 提案した技術スタックについてご意見をお聞かせください。

1.,2. については上記で回答しました。  
3.についても問題ありません。ご提案いただいた構成で進めましょう。
