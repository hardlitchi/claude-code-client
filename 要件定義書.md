# Claude Code Client 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Claude Code Client

### 1.2 目的
Claude Code をWebブラウザから操作可能にするアプリケーションサーバーを開発し、いつでもどこでもClaude Codeの開発セッションにアクセスできる環境を提供する。

### 1.3 ターゲットユーザー
- 開発者
- Claude Code を使用したプロジェクト管理者
- リモートワークでの開発作業者

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 基本機能
1. **認証機能**
   - ID/パスワード認証
   - 将来的なOAuth認証対応（Google/GitHub等）
   - セッション管理

2. **Terminal操作機能**
   - Webブラウザ上でのターミナルアクセス
   - サーバー上のシェルへの直接アクセス
   - sudo権限対応（sudores設定ユーザー）

3. **Claude Code統合機能**
   - Claude Code SDK を使用したプログラマティック制御
   - チャット形式でのClaude Code操作
   - セッション状態の永続化
   - 複数セッション管理

4. **通知機能**
   - Web Push APIによるプッシュ通知
   - Claudeからの確認要求通知
   - 作業完了通知
   - モバイル対応

5. **外部連携機能**
   - Webhook機能（LINE/Slack/Discord）
   - APIキーによる認証
   - 各サービスのベストプラクティス準拠

#### 2.1.2 管理機能
1. **ユーザー管理**
   - 複数ユーザー同時利用
   - ユーザー権限管理
   - セッション分離

2. **ログ・監視機能**
   - ユーザー操作ログ
   - 作業内容要約ログ
   - エラーログとユーザー通知
   - パフォーマンス監視

### 2.2 非機能要件

#### 2.2.1 セキュリティ要件
- **プロセス分離**: Dockerコンテナによるユーザー環境分離
- **権限制御**: 専用実行ユーザーでの権限制御
- **データ保護**: セッション情報のデータベース暗号化
- **アクセス制御**: ユーザー間でのファイルアクセス制限

#### 2.2.2 性能要件
- **同時接続**: 複数ユーザー同時接続対応
- **リアルタイム通信**: WebSocketによる低遅延通信
- **レスポンス時間**: Terminal操作の応答時間 < 100ms

#### 2.2.3 運用要件
- **可用性**: サーバー再起動時のセッション復旧
- **拡張性**: ユーザー数増加に対応可能な設計
- **保守性**: 構造化ログによる問題特定

## 3. システム構成

### 3.1 技術スタック

#### 3.1.1 バックエンド
- **Webフレームワーク**: FastAPI
  - WebSocket対応
  - 自動API文書生成
  - 高性能でPython型ヒント対応

- **データベース**: PostgreSQL + SQLAlchemy
  - 堅牢性とパフォーマンス
  - JSON型対応（セッション情報格納）

- **WebSocket**: FastAPI内蔵WebSocket
  - リアルタイム通信

- **認証**: FastAPI Security + JWT
  - 将来のOAuth対応準備

#### 3.1.2 フロントエンド
- **フレームワーク**: Vue.js 3 + TypeScript
  - 学習コストが低い
  - リアクティブUI更新
  - Terminal.jsとの相性

- **ターミナル**: xterm.js
  - Web標準ターミナルエミュレーター
  - VSCodeで使用実績

- **状態管理**: Pinia（Vue公式推奨）
- **CSS**: Tailwind CSS

#### 3.1.3 インフラ構成
- **コンテナ化**: Docker + Docker Compose
- **リバースプロキシ**: Nginx
- **プロセス管理**: Docker
- **ログ収集**: 構造化ログ

### 3.2 システムアーキテクチャ

```
[ブラウザ] 
    ↓ HTTPS/WebSocket
[Nginx] 
    ↓
[FastAPI Server]
    ↓
[PostgreSQL] + [Docker Containers]
                     ↓
               [Claude Code SDK]
```

## 4. 機能詳細仕様

### 4.1 認証システム
- **ログイン画面**: ID/パスワード入力
- **JWT Token**: セッション管理
- **セッション永続化**: データベース保存
- **自動ログアウト**: セッション期限（現在は無期限）

### 4.2 Terminal機能
- **実装方式**: xterm.js + WebSocket
- **バックエンド**: pty（pseudoterminal）
- **セキュリティ**: Dockerコンテナ内実行
- **コマンド制限**: なし（コンテナレベルで制御）

### 4.3 Claude Code統合
- **SDK統合**: Python Claude Code SDK
- **通信方式**: 非同期処理
- **セッション管理**: データベース永続化
- **エラーハンドリング**: ユーザー通知 + ログ出力

### 4.4 通知システム
- **Web Push**: Service Worker + Push API
- **Webhook**: HTTP POST による外部サービス連携
- **通知タイミング**: 
  - Claude確認要求時
  - 作業完了時
  - エラー発生時

## 5. データベース設計

### 5.1 主要テーブル
- **users**: ユーザー情報
- **sessions**: Claude Codeセッション情報
- **notifications**: 通知履歴
- **webhooks**: Webhook設定
- **logs**: 操作ログ

### 5.2 セッション情報格納
- JSON形式でClaude Code状態を保存
- 作業ディレクトリ情報
- 実行中タスク情報

## 6. 開発フェーズ

### 6.1 フェーズ1（MVP - 4週間）
1. 基本Web UI構築
2. 単一ユーザー向けTerminal機能
3. Claude Code SDK基本統合
4. 簡単な認証機能

### 6.2 フェーズ2（マルチユーザー対応 - 6週間）
1. ユーザー管理機能
2. Dockerベースセッション分離
3. 基本通知機能
4. データベース最適化

### 6.3 フェーズ3（高度な機能 - 4週間）
1. Webhook連携
2. OAuth認証
3. モバイル対応
4. パフォーマンス最適化

## 7. 運用要件

### 7.1 デプロイ環境
- **OS**: Ubuntu 20.04 LTS以上
- **Docker**: 20.10以上
- **PostgreSQL**: 13以上
- **メモリ**: 最低4GB（ユーザー数に応じて拡張）

### 7.2 バックアップ戦略
- **データベース**: 日次自動バックアップ
- **ユーザーデータ**: Dockerボリューム定期バックアップ
- **設定ファイル**: Git管理

### 7.3 監視項目
- **サーバーリソース**: CPU/メモリ/ディスク使用率
- **アプリケーション**: レスポンス時間/エラー率
- **データベース**: クエリ性能/接続数

## 8. セキュリティ考慮事項

### 8.1 脅威分析
- **不正アクセス**: JWT認証 + HTTPS
- **権限昇格**: Dockerコンテナ分離
- **データ漏洩**: データベース暗号化
- **DoS攻撃**: レート制限

### 8.2 セキュリティ対策
- **入力検証**: 全API入力値検証
- **出力エスケープ**: XSS対策
- **CSRF対策**: CSRFトークン
- **セキュリティヘッダー**: 適切なHTTPヘッダー設定

## 9. 品質保証

### 9.1 テスト戦略
- **単体テスト**: pytest（カバレッジ80%以上）
- **統合テスト**: API テスト
- **E2Eテスト**: Selenium WebDriver
- **セキュリティテスト**: セキュリティスキャン

### 9.2 コード品質
- **コーディング規約**: PEP8（Python）、ESLint（TypeScript）
- **コードレビュー**: Pull Request必須
- **静的解析**: mypy、TypeScript strict mode

---

**注意事項**:
- デプロイ機能は将来拡張として除外
- 本要件定義書は開発開始前の最終確認を経て確定